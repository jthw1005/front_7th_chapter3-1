name: Sync Figma Tokens

on:
  push:
    branches:
      - figma-token
    paths:
      - 'figmaToken.json'

  # Manual trigger for testing
  workflow_dispatch:

jobs:
  sync-tokens:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout figma-token branch
        uses: actions/checkout@v4
        with:
          ref: figma-token
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create sync branch
        id: create_branch
        run: |
          # Generate unique branch name with timestamp
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="figma-tokens/sync-${TIMESTAMP}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          # Create and checkout new branch from main
          git fetch origin main
          git checkout -b ${BRANCH_NAME} origin/main

          # Copy figmaToken.json from figma-token branch
          git checkout figma-token -- figmaToken.json

      - name: Transform tokens to CSS
        run: |
          # Run transformation script
          node scripts/transform-tokens.cjs

          # Check if there are changes
          if git diff --quiet packages/after/src/styles/components.css; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in components.css"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in components.css"
          fi
        id: transform

      - name: Commit changes
        if: steps.transform.outputs.has_changes == 'true'
        run: |
          git add packages/after/src/styles/components.css
          git commit -m "chore: sync design tokens from Figma

          - Updated @theme block in components.css
          - Synced from figmaToken.json (figma-token branch)

          ğŸ¨ Auto-generated by Figma Tokens workflow"

      - name: Push changes
        if: steps.transform.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.create_branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.transform.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Read token count from figmaToken.json
          TOKEN_COUNT=$(node -e "
            const fs = require('fs');
            const tokens = JSON.parse(fs.readFileSync('figmaToken.json', 'utf8'));
            console.log(Object.keys(tokens.global || {}).length);
          ")

          # Create PR with detailed body
          gh pr create \
            --title "ğŸ¨ Sync design tokens from Figma" \
            --body "$(cat <<'EOF'
          ## Summary
          This PR synchronizes design tokens from Figma Tokens Studio to the CSS design system.

          ### Changes
          - âœ… Updated \`@theme\` block in [components.css](packages/after/src/styles/components.css)
          - ğŸ“Š Synced **${TOKEN_COUNT}** design tokens from \`figmaToken.json\`
          - ğŸ”„ Source: \`figma-token\` branch

          ### Token Categories
          - Colors (Primary, Secondary, Success, Danger, Warning)
          - Spacing
          - Typography (Font sizes, weights, line heights)

          ### Testing Checklist
          - [ ] Visual regression testing with Storybook
          - [ ] Verify token values match Figma designs
          - [ ] Check dark mode compatibility (if applicable)
          - [ ] Test components using updated tokens

          ### How to Review
          1. Check the \`@theme\` block changes in [components.css](packages/after/src/styles/components.css)
          2. Run Storybook: \`pnpm storybook\`
          3. Verify components render correctly with new token values
          4. Compare with Figma design source

          ---
          ğŸ¤– Generated with [GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Co-Authored-By: Figma Tokens Sync <noreply@github.com>
          EOF
          )" \
            --base main \
            --head ${{ steps.create_branch.outputs.branch_name }}

      - name: Summary
        run: |
          if [ "${{ steps.transform.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Design tokens synced successfully"
            echo "ğŸ“ Pull request created: ${{ steps.create_branch.outputs.branch_name }} â†’ main"
          else
            echo "â„¹ï¸  No changes detected - tokens are already in sync"
          fi
