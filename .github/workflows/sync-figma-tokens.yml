name: Sync Figma Tokens

on:
  push:
    branches:
      - figma-token
    paths:
      - 'figmaToken.json'

  # Manual trigger for testing
  workflow_dispatch:

jobs:
  sync-tokens:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout figma-token branch
        uses: actions/checkout@v4
        with:
          ref: figma-token
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Transform tokens to CSS
        run: |
          # Run transformation script
          node scripts/transform-tokens.cjs

          # Check if there are changes in token files
          if git diff --quiet packages/after/src/tokens/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in token files"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in token files"
          fi
        id: transform

      - name: Commit and push changes
        if: steps.transform.outputs.has_changes == 'true'
        run: |
          git add packages/after/src/tokens/
          git commit -m "chore: sync design tokens from Figma

          - Updated token files (color.css, typography.css, spacing.css)
          - Synced from figmaToken.json

          üé® Auto-generated by Figma Tokens workflow"

          git push origin figma-token

      - name: Create Pull Request
        if: steps.transform.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if PR already exists for figma-token branch
          EXISTING_PR=$(gh pr list --head figma-token --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "‚ÑπÔ∏è  PR #$EXISTING_PR already exists for figma-token branch"
            exit 0
          fi

          # Read token count from figmaToken.json
          TOKEN_COUNT=$(node -e "
            const fs = require('fs');
            const tokens = JSON.parse(fs.readFileSync('figmaToken.json', 'utf8'));
            console.log(Object.keys(tokens.global || {}).length);
          ")

          # Create PR with detailed body
          gh pr create \
            --title "üé® Sync design tokens from Figma" \
            --body "$(cat <<'EOF'
          ## Summary
          This PR synchronizes design tokens from Figma Tokens Studio to the CSS design system.

          ### Changes
          - ‚úÖ Updated token files:
            - [color.css](packages/after/src/tokens/color.css)
            - [typography.css](packages/after/src/tokens/typography.css)
            - [spacing.css](packages/after/src/tokens/spacing.css)
          - üìä Synced **${TOKEN_COUNT}** design tokens from \`figmaToken.json\`
          - üîÑ Source: \`figma-token\` branch

          ### Token Categories
          - Colors (Primary, Secondary, Success, Danger, Warning)
          - Spacing
          - Typography (Font sizes, weights, line heights)

          ### Testing Checklist
          - [ ] Visual regression testing with Storybook
          - [ ] Verify token values match Figma designs
          - [ ] Check dark mode compatibility (if applicable)
          - [ ] Test components using updated tokens

          ### How to Review
          1. Check the token file changes in [packages/after/src/tokens/](packages/after/src/tokens/)
          2. Run Storybook: \`pnpm storybook\`
          3. Verify components render correctly with new token values
          4. Compare with Figma design source

          ---
          ü§ñ Generated with [GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Co-Authored-By: Figma Tokens Sync <noreply@github.com>
          EOF
          )" \
            --base main \
            --head figma-token

      - name: Summary
        run: |
          if [ "${{ steps.transform.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ Design tokens synced successfully"
            echo "üìù Pull request created: figma-token ‚Üí main"
          else
            echo "‚ÑπÔ∏è  No changes detected - tokens are already in sync"
          fi
